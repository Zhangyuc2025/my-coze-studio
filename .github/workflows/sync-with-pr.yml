name: ğŸ”„ Sync with PR

on:
  # æ¯å¤© UTC 0ç‚¹ (åŒ—äº¬æ—¶é—´ 8ç‚¹) è‡ªåŠ¨è¿è¡Œ
  schedule:
    - cron: '0 0 * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  sync-and-pr:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ”§ Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: â¬‡ï¸ Fetch upstream repository
        run: |
          git remote add upstream https://github.com/coze-dev/coze-studio.git
          git fetch upstream main

      - name: ğŸ” Check for changes
        id: check
        run: |
          UPSTREAM_SHA=$(git rev-parse upstream/main)
          CURRENT_SHA=$(git rev-parse HEAD)

          echo "upstream_sha=$UPSTREAM_SHA" >> $GITHUB_OUTPUT
          echo "current_sha=$CURRENT_SHA" >> $GITHUB_OUTPUT

          if [ "$UPSTREAM_SHA" != "$CURRENT_SHA" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ”„ Create upstream-sync branch and push
        if: steps.check.outputs.has_changes == 'true'
        run: |
          # åˆ›å»ºæˆ–åˆ‡æ¢åˆ° upstream-sync åˆ†æ”¯
          if git show-ref --verify --quiet refs/heads/upstream-sync; then
            git checkout upstream-sync
            git reset --hard upstream/main
          else
            git checkout -b upstream-sync upstream/main
          fi

          # æ¨é€åˆ°è¿œç¨‹
          git push -f origin upstream-sync

      - name: ğŸ“ Create Pull Request
        if: steps.check.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: sync-upstream-sync
          base: upstream-sync
          title: 'ğŸ”„ Auto sync from upstream'
          body: |
            ## ğŸ”„ è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸æ›´æ–°

            æ­¤PRè‡ªåŠ¨ç”Ÿæˆï¼Œç”¨äºåŒæ­¥ä¸Šæ¸¸ä»“åº“çš„æœ€æ–°å˜æ›´ã€‚

            ### ğŸ“Š åŒæ­¥ä¿¡æ¯
            - **ä¸Šæ¸¸æœ€æ–°æäº¤**: `${{ steps.check.outputs.upstream_sha }}`
            - **å½“å‰æäº¤**: `${{ steps.check.outputs.current_sha }}`
            - **æ‰§è¡Œæ—¶é—´**: $(date)

            ### ğŸ“ å˜æ›´æ—¥å¿—
            ```
            $(git log --oneline ${{ steps.check.outputs.current_sha }}..${{ steps.check.outputs.upstream_sha }})
            ```

            ### âœ… ä¸‹ä¸€æ­¥
            - [ ] å®¡æ ¸å˜æ›´
            - [ ] åˆå¹¶åˆ° `upstream-sync` åˆ†æ”¯
            - [ ] åœ¨ä½ çš„åŠŸèƒ½åˆ†æ”¯ä¸Šåˆå¹¶æ›´æ–°

            ---
            *æ­¤PRç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º*
          commit-message: 'ğŸ”„ Auto sync from upstream'
          delete-branch: true