name: ğŸ”„ Auto Sync Upstream

on:
  # æ¯å¤© UTC 0ç‚¹ (åŒ—äº¬æ—¶é—´ 8ç‚¹) è‡ªåŠ¨è¿è¡Œ
  schedule:
    - cron: '0 0 * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no changes detected'
        required: false
        default: 'false'
        type: boolean

  # å½“ upstream/main æœ‰æ–°æäº¤æ—¶è§¦å‘
  push:
    branches:
      - upstream/main

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ”§ Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: â¬‡ï¸ Fetch upstream repository
        run: |
          git remote add upstream https://github.com/coze-dev/coze-studio.git
          git fetch upstream main

      - name: ğŸ” Check for changes
        id: check
        run: |
          UPSTREAM_SHA=$(git rev-parse upstream/main)
          CURRENT_SHA=$(git rev-parse HEAD)

          echo "upstream_sha=$UPSTREAM_SHA" >> $GITHUB_OUTPUT
          echo "current_sha=$CURRENT_SHA" >> $GITHUB_OUTPUT

          if [ "$UPSTREAM_SHA" != "$CURRENT_SHA" ] || [ "${{ github.event.inputs.force_sync }}" == "true" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ”„ Sync to upstream-sync branch
        if: steps.check.outputs.has_changes == 'true'
        run: |
          # åˆ›å»ºæˆ–åˆ‡æ¢åˆ° upstream-sync åˆ†æ”¯
          if git show-ref --verify --quiet refs/heads/upstream-sync; then
            git checkout upstream-sync
            git reset --hard upstream/main
          else
            git checkout -b upstream-sync upstream/main
          fi

          # æ¨é€åˆ°è¿œç¨‹
          git push -f origin upstream-sync

      - name: ğŸ“Š Create sync summary
        if: always()
        run: |
          echo "## ğŸ”„ Upstream Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check.outputs.has_changes }}" == "true" ]; then
            echo "âœ… **çŠ¶æ€**: åŒæ­¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- ä¸Šæ¸¸æœ€æ–°æäº¤: \`${{ steps.check.outputs.upstream_sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- æœ¬åœ°æäº¤: \`${{ steps.check.outputs.current_sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å·²æ¨é€åˆ° `origin/upstream-sync` åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **çŠ¶æ€**: æ²¡æœ‰æ–°æ›´æ–°" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å½“å‰åˆ†æ”¯å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€åŒæ­¥" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ·ï¸ Create tag on sync (optional)
        if: steps.check.outputs.has_changes == 'true'
        run: |
          TAG_NAME="sync-$(date +%Y%m%d-%H%M%S)"
          git tag -a "$TAG_NAME" -m "Auto sync from upstream on $(date)"
          git push origin "$TAG_NAME"

      - name: ğŸ“¢ Notify success
        if: steps.check.outputs.has_changes == 'true'
        run: |
          echo "ğŸ‰ åŒæ­¥å®Œæˆï¼"
          echo "æ–°ä»£ç å·²æ¨é€åˆ° upstream-sync åˆ†æ”¯"
          echo ""
          echo "ğŸ”— å¿«é€Ÿé“¾æ¥:"
          echo "- ä»“åº“: https://github.com/${{ github.repository }}"
          echo "- upstream-sync åˆ†æ”¯: https://github.com/${{ github.repository }}/tree/upstream-sync"
          echo "- å¯¹æ¯”å˜æ›´: https://github.com/${{ github.repository }}/compare/main...upstream-sync"